<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ubycore</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%233B82F6' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z'%3E%3C/path%3E%3Ccircle cx='12' cy='10' r='3'%3E%3C/circle%3E%3C/svg%3E">
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@v8.2.0/ol.css">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilos generales para un aspecto tipo Apple */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            overflow: hidden;
            background-color: #f3f4f6; /* Un gris claro de fondo */
        }
        #map {
            height: 100%;
            width: 100%;
            z-index: 0;
        }
        
        /* Estilos para las superposiciones modales con efecto de desenfoque */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 30000;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-box {
            background-color: rgba(255, 255, 255, 0.95);
            color: #1f2937;
            padding: 2rem;
            border-radius: 1.5rem; /* Bordes más redondeados */
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            text-align: left;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.show .modal-box {
            transform: scale(1);
        }
        
        .permission-buttons {
            display: flex;
            flex-direction: column;
            sm:flex-direction-row;
            gap: 0.75rem;
            margin-top: 1.5rem;
        }
        
        .permission-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            width: 100%;
            text-align: center;
        }
        
        #allow-location, #retry-location, #submit-form-button, #confirm-report-incident-button, #submit-incident-button {
            background-color: #007AFF; /* Azul de Apple */
            color: white;
        }
        #allow-location:hover, #retry-location:hover, #submit-form-button:hover, #confirm-report-incident-button:hover, #submit-incident-button:hover {
            background-color: #0056b3;
        }
        
        #deny-location, #use-default-location, #cancel-report-incident-button {
            background-color: #E5E5EA; /* Gris claro de Apple */
            color: #007AFF;
        }
        #deny-location:hover, #use-default-location:hover, #cancel-report-incident-button:hover {
            background-color: #DCDCE0;
        }

        /* Estilos del formulario */
        #form-modal-overlay .form-input, #incident-form-overlay .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
            background-color: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #form-modal-overlay .form-input:focus, #incident-form-overlay .form-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.25);
        }
        #close-form-button, #close-incident-form-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: #d1d5db;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 16px;
            cursor: pointer;
            color: #8e8e93;
            display:flex;
            align-items:center;
            justify-content:center;
        }
        #close-form-button:hover, #close-incident-form-button:hover {
            background-color: #bcbcc1;
            color: #1f2937;
        }

        /* Indicador de carga y notificación */
        #notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(30, 30, 30, 0.85); backdrop-filter: blur(5px); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #notification.show { opacity: 1; }
        #route-loading-indicator { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: rgba(30, 30, 30, 0.85); backdrop-filter: blur(5px); color: white; padding: 10px 20px; border-radius: 20px; z-index: 10000; opacity: 0; transition: opacity 0.5s ease-in-out; pointer-events: none; }
        #route-loading-indicator.show { opacity: 1; }
        
        /* Icono de destino personalizado */
        .destination-icon-div { 
            width: 32px; height: 32px; 
            background-color: #34C759; /* Verde de Apple */
            border-radius: 50% 50% 50% 0; 
            transform: rotate(-45deg); 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.2); 
            border: 2px solid white; 
        }
        .destination-icon-div svg { transform: rotate(45deg); }
        
        /* Estilo antiguo para los marcadores de ruta (A y B) */
        .route-marker-div { 
            background-color: #10B981; 
            color: white; 
            border-radius: 50%; 
            text-align: center; 
            font-weight: bold; 
            line-height: 20px; 
            border: 2px solid white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); 
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Estilo para el marcador de usuario */
        .user-marker-div {
            width: 20px;
            height: 20px;
            background-color: #007AFF; /* Azul de Apple */
            border-radius: 50%;
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Estilo para el marcador de incidente */
        .incident-icon-div {
            width: 32px;
            height: 32px;
            background-color: #FF3B30; /* Rojo de Apple */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            border: 2px solid white;
        }
        .incident-icon-div svg {
            color: white;
        }

        /* Botón flotante para reportar incidente */
        #report-incident-button {
            position: absolute;
            bottom: 24px;
            left: 20px; /* Alineado a la izquierda */
            z-index: 10;
            background-color: #FF3B30; /* Rojo de Apple */
            color: white;
            padding: 1rem;
            border-radius: 50%;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }
        #report-incident-button:hover {
            background-color: #CC0000;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div id="location-permission-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-2xl font-bold mb-2">Permiso de ubicación</h2>
            <p class="text-gray-600">Para mostrarte en el mapa y calcular rutas, Ubycore necesita acceder a tu ubicación. Tus datos de ubicación son privados.</p>
            <div class="permission-buttons">
                <button id="allow-location" class="permission-button">Permitir ubicación</button>
                <button id="deny-location" class="permission-button">No permitir</button>
            </div>
        </div>
    </div>
    
    <div id="location-error-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-xl font-bold mb-2 text-red-600">Error de Permiso de Ubicación</h2>
            <div class="text-gray-700 space-y-4">
                <p>Ubycore no puede acceder a tu ubicación. Para obtener indicaciones y ver tu posición, necesitas habilitar los servicios de ubicación en tu navegador.</p>
                <div>
                    <h3 class="font-semibold mb-2">Cómo solucionarlo:</h3>
                    <ul class="list-disc list-inside text-sm space-y-2 bg-gray-100 p-3 rounded-lg">
                        <li><strong>Chrome:</strong> Ve a Configuración &rarr; Privacidad y seguridad &rarr; Configuración de sitios &rarr; Ubicación y asegúrate de que este sitio pueda preguntar por tu ubicación.</li>
                        <li><strong>Safari:</strong> Ve a Preferencias &rarr; Sitios web &rarr; Ubicación. Selecciona este sitio y elije "Permitir".</li>
                        <li><strong>Firefox:</strong> Ve a Opciones &rarr; Privacidad & seguridad &rarr; Permisos &rarr; Ubicación (Configuración) y comprueba que este sitio no esté bloqueado.</li>
                    </ul>
                </div>
                <p>Después de ajustar la configuración, por favor, reintenta.</p>
            </div>
            <div class="permission-buttons">
                <button id="retry-location" class="permission-button">Reintentar</button>
                <button id="use-default-location" class="permission-button">Usar ubicación por defecto</button>
            </div>
        </div>
    </div>
    
    <div id="form-modal-overlay" class="modal-overlay">
        <div class="modal-box">
            <button id="close-form-button" title="Cerrar">&#x2715;</button>
            <h2 class="text-2xl font-bold mb-2">Ayúdanos a mejorar</h2>
            <p class="text-gray-600 mb-6">Por favor, completa la siguiente información. Es rápido y anónimo.</p>
            <form id="data-form">
                <div>
                    <label for="nombre" class="font-semibold text-gray-700">Nombre Completo</label>
                    <input type="text" id="nombre" name="nombre" class="form-input" required>
                </div>
                <div>
                    <label for="edad" class="font-semibold text-gray-700">Edad</label>
                    <input type="number" id="edad" name="edad" class="form-input" required>
                </div>
                <div>
                    <label for="sexo" class="font-semibold text-gray-700">Sexo</label>
                    <select id="sexo" name="sexo" class="form-input" required>
                        <option value="">Seleccione...</option>
                        <option value="Masculino">Masculino</option>
                        <option value="Femenino">Femenino</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label for="nivelEscolar" class="font-semibold text-gray-700">Nivel Escolar</label>
                    <select id="nivelEscolar" name="nivelEscolar" class="form-input" required>
                        <option value="">Seleccione...</option>
                        <option value="Primaria">Primaria</option>
                        <option value="Secundaria">Secundaria</option>
                        <option value="Bachillerato">Bachillerato</option>
                        <option value="Licenciatura">Licenciatura</option>
                        <option value="Posgrado">Posgrado</option>
                        <option value="Ninguno">Ninguno</option>
                    </select>
                </div>
                <div class="text-right mt-4">
                     <button type="submit" id="submit-form-button" class="permission-button w-full sm:w-auto">Enviar Datos</button>
                </div>
            </form>
        </div>
    </div>

    <div id="report-incident-overlay" class="modal-overlay">
        <div class="modal-box">
            <h2 class="text-2xl font-bold mb-2">Reportar un Incidente</h2>
            <p class="text-gray-600">¿Deseas reportar un incidente de tráfico o un evento en tu ubicación actual?</p>
            <div class="permission-buttons">
                <button id="confirm-report-incident-button" class="permission-button">Sí, reportar</button>
                <button id="cancel-report-incident-button" class="permission-button">No, gracias</button>
            </div>
        </div>
    </div>

    <div id="incident-form-overlay" class="modal-overlay">
        <div class="modal-box">
            <button id="close-incident-form-button" title="Cerrar">&#x2715;</button>
            <h2 class="text-2xl font-bold mb-2">Detalles del Incidente</h2>
            <p class="text-gray-600 mb-6">Por favor, describe el incidente. Tu ubicación actual será registrada.</p>
            <form id="incident-form">
                <div>
                    <label for="incident-type" class="font-semibold text-gray-700">Tipo de Incidente</label>
                    <select id="incident-type" name="incidentType" class="form-input" required>
                        <option value="">Seleccione...</option>
                        <option value="Tráfico Lento">Tráfico Lento</option>
                        <option value="Accidente">Accidente</option>
                        <option value="Cierre de Carretera">Cierre de Carretera</option>
                        <option value="Peligro en la Vía">Peligro en la Vía</option>
                        <option value="Obra">Obra</option>
                        <option value="Evento Público">Evento Público</option>
                        <option value="Otro">Otro</option>
                    </select>
                </div>
                <div>
                    <label for="incident-description" class="font-semibold text-gray-700">Descripción (Opcional)</label>
                    <textarea id="incident-description" name="description" class="form-input" rows="3"></textarea>
                </div>
                <div class="text-right mt-4">
                     <button type="submit" id="submit-incident-button" class="permission-button w-full sm:w-auto">Reportar Incidente</button>
                </div>
            </form>
        </div>
    </div>

    <div class="relative h-screen w-screen flex flex-col">
        <div class="absolute top-0 left-0 right-0 z-10 p-4">
            <div class="max-w-3xl mx-auto flex items-center space-x-3">
                <div id="search-container" class="flex-grow p-4 bg-white/80 backdrop-blur-md border border-gray-200/50 rounded-2xl shadow-lg hover:shadow-xl transition-shadow cursor-pointer flex items-center space-x-3">
                     <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="text-gray-400"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                     <span id="search-input-display" class="text-gray-500">¿A dónde vas?</span>
                </div>
                <button id="go-button"
                        class="bg-white/80 backdrop-blur-md text-gray-700 font-semibold p-4 rounded-2xl shadow-lg hover:shadow-xl transition-all flex-shrink-0">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                </button>
            </div>
        </div>

        <div id="map" class="flex-grow"></div>

        <button id="center-location-button" title="Mi Ubicación"
                class="absolute bottom-24 right-5 z-10 bg-white/80 backdrop-blur-md p-3 rounded-full shadow-lg hover:bg-white transition-all">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#007AFF" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 2L22 8.5 12 22 2 8.5 12 2z"></path><path d="M12 22V12"></path>
            </svg>
        </button>

        <button id="report-incident-button" title="Reportar Incidente">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
        </button>

        <div id="notification"></div>
        <div id="route-loading-indicator">Cargando...</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/ol@v8.2.0/dist/ol.js"></script>
    <script>
        // Import necessary OpenLayers modules
        const { Map, View } = ol;
        const { Tile: TileLayer, Vector: VectorLayer } = ol.layer;
        const { OSM, Vector: VectorSource } = ol.source;
        const { Style, Stroke, Fill, Circle } = ol.style;
        const { Point, LineString } = ol.geom;
        const { fromLonLat, toLonLat } = ol.proj;
        const { Overlay } = ol;
        const { Zoom: ZoomControl } = ol.control;

        // Configuration constants
        const PUEBLA_LAT = 19.0414;
        const PUEBLA_LNG = -98.2063;
        const SEARCH_PAGE_URL = 'search_screen.html';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCjSRkHlyfjWcgnd2JfFbfVtfsnLisVCXZLanIULRk8iWwW7bTBVZx3SIgxewaMupU/exec';
        const FORM_SUBMIT_URL = 'https://script.google.com/macros/s/AKfycbwiukXVfPeMosfuBPil3XR2xl9sVjEf1-AOmcEdNts5ndziYxlZUEPBOlwOlhWVWbzl/exec';
        const INCIDENT_APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbycx21bkBonZjjklyPfirnzUXFaFGF6aeb2DSKZP81EGD2JcQgQHgWWBCgs1mY-Ysum/exec'; // New API for incidents
        const LOCATION_PERMISSION_KEY = 'ubycore_locationPermission';

        // Map and interface variables
        let map;
        let userLocationOverlay; // Using Overlay for custom HTML marker
        let destinationOverlay; // Using Overlay for custom HTML marker
        let routeVectorSource; // Source for route polyline and start/end markers (now also incidents)
        let routeVectorLayer; // Layer for route features
        let routeStartOverlay, routeEndOverlay; // Overlays for route start/end markers

        let userCurrentLatitude = PUEBLA_LAT;
        let userCurrentLongitude = PUEBLA_LNG;

        // References to UI elements
        const routeLoadingIndicator = document.getElementById('route-loading-indicator');
        const locationPermissionOverlay = document.getElementById('location-permission-overlay');
        const locationErrorOverlay = document.getElementById('location-error-overlay');
        const formModalOverlay = document.getElementById('form-modal-overlay');
        const dataForm = document.getElementById('data-form');
        const searchInputDisplay = document.getElementById('search-input-display');

        // New Incident UI elements
        const reportIncidentOverlay = document.getElementById('report-incident-overlay');
        const incidentFormOverlay = document.getElementById('incident-form-overlay');
        const incidentForm = document.getElementById('incident-form');

        /**
         * Muestra/oculta un modal.
         * @param {HTMLElement} overlay - El elemento del modal.
         * @param {boolean} show - true para mostrar, false para ocultar.
         */
        function toggleModal(overlay, show) {
            if (show) {
                overlay.classList.add('show');
            } else {
                overlay.classList.remove('show');
            }
        }

        /**
         * Muestra un mensaje de notificación temporal.
         * @param {string} message - El mensaje a mostrar.
         * @param {number} duration - Duración en milisegundos para mostrar el mensaje.
         */
        function showNotification(message, duration = 3000) {
            const el = document.getElementById('notification');
            if (!el) return;
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), duration);
        }

        /**
         * Inicializa el mapa y gestiona los permisos de ubicación.
         */
        function initMap() {
            try {
                // Create the vector source for all dynamic features (user, destination, route, incidents)
                routeVectorSource = new VectorSource();
                routeVectorLayer = new VectorLayer({
                    source: routeVectorSource
                });

                map = new Map({
                    target: 'map',
                    layers: [
                        new TileLayer({
                            source: new OSM(), // Changed to OSM source for OpenStreetMap tiles
                            attributions: '© OpenStreetMap contributors' // Correct attribution for OSM
                        }),
                        routeVectorLayer // Add the vector layer for features
                    ],
                    view: new View({
                        center: fromLonLat([PUEBLA_LNG, PUEBLA_LAT]), // OpenLayers uses [longitude, latitude]
                        zoom: 13,
                        minZoom: 2,
                        maxZoom: 20
                    }),
                    controls: [] // Clear default controls to add custom ones
                });

                // Add custom zoom control to bottom right
                map.addControl(new ZoomControl({
                    target: document.createElement('div'), // Create a dummy div to place control
                    className: 'ol-zoom ol-control-bottom-right' // Add custom class for styling with Tailwind if needed
                }));


                const locationPreference = localStorage.getItem(LOCATION_PERMISSION_KEY);
                
                if (locationPreference === null) {
                    toggleModal(locationPermissionOverlay, true);
                } else if (locationPreference === 'allowed') {
                    requestUserLocation();
                } else { // 'denied'
                    toggleModal(locationErrorOverlay, true);
                }

                // Load incidents when map initializes
                loadIncidents();

            } catch (error) {
                console.error("Error al inicializar el mapa:", error);
                document.body.innerHTML = '<h1>Error crítico al cargar el mapa.</h1>';
            }
        }

        /**
         * Solicita la ubicación actual del usuario.
         */
        function requestUserLocation() {
            if (!navigator.geolocation) {
                toggleModal(locationErrorOverlay, true);
                return;
            }
            
            navigator.geolocation.getCurrentPosition(position => {
                const { latitude, longitude } = position.coords;
                userCurrentLatitude = latitude;
                userCurrentLongitude = longitude;
                localStorage.setItem(LOCATION_PERMISSION_KEY, 'allowed');
                const userCoords = fromLonLat([longitude, latitude]); // Convert to Web Mercator

                map.getView().setCenter(userCoords);
                map.getView().setZoom(16);

                if (userLocationOverlay) {
                    userLocationOverlay.setPosition(userCoords);
                } else {
                    // Crea un elemento HTML personalizado para el marcador de usuario
                    const userMarkerEl = document.createElement('div');
                    userMarkerEl.className = 'user-marker-div';
                    userLocationOverlay = new Overlay({
                        element: userMarkerEl,
                        position: userCoords,
                        positioning: 'center-center' // Centra el elemento HTML en las coordenadas
                    });
                    map.addOverlay(userLocationOverlay);
                }
                processUrlParameters();
            }, () => {
                localStorage.setItem(LOCATION_PERMISSION_KEY, 'denied');
                toggleModal(locationErrorOverlay, true);
            }, { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 });
        }
        
        /**
         * Establece una ubicación de usuario predeterminada si la geolocalización es denegada o no está disponible.
         */
        function setDefaultUserLocation() {
            const defaultCoords = fromLonLat([PUEBLA_LNG, PUEBLA_LAT]);
            userCurrentLatitude = PUEBLA_LAT;
            userCurrentLongitude = PUEBLA_LNG;

            if (userLocationOverlay) {
                userLocationOverlay.setPosition(defaultCoords);
            } else {
                const userMarkerEl = document.createElement('div');
                userMarkerEl.className = 'user-marker-div';
                userLocationOverlay = new Overlay({
                    element: userMarkerEl,
                    position: defaultCoords,
                    positioning: 'center-center'
                });
                map.addOverlay(userLocationOverlay);
            }

            // Asegura que la vista del mapa incluya la ubicación predeterminada si aún no lo hace
            const view = map.getView();
            const currentExtent = view.calculateExtent(map.getSize());
            if (!ol.extent.containsCoordinate(currentExtent, defaultCoords)) {
                 view.setCenter(defaultCoords);
                 view.setZoom(13);
            }
            processUrlParameters();
        }

        /**
         * Borra todas las capas dinámicas (destino, ruta, marcadores de ruta).
         * DOES NOT clear incident markers as they are refreshed by loadIncidents().
         */
        function clearMapLayers() {
            // Remove route/destination specific overlays
            if (destinationOverlay) {
                map.removeOverlay(destinationOverlay);
                destinationOverlay = null;
            }
            if (routeStartOverlay) {
                map.removeOverlay(routeStartOverlay);
                routeStartOverlay = null;
            }
            if (routeEndOverlay) {
                map.removeOverlay(routeEndOverlay);
                routeEndOverlay = null;
            }
            // Clear only route features from routeVectorSource. Incident markers will be re-added by loadIncidents().
            const featuresToRemove = routeVectorSource.getFeatures().filter(feature => 
                !feature.get('type') || (feature.get('type') !== 'incident')
            );
            featuresToRemove.forEach(feature => routeVectorSource.removeFeature(feature));
        }

        /**
         * Parsea una cadena de coordenadas a un número flotante.
         * Asume que si no hay punto decimal, debe insertarse después de los dos primeros dígitos
         * (después de cualquier signo negativo inicial).
         * @param {string} coordString - La cadena de la coordenada (ej. "190414" o "-982063").
         * @returns {number} La coordenada parseada como un número flotante.
         */
        function parseCoordinate(coordString) {
            let s = String(coordString);
            s = s.replace(',', '.'); // Manejar la coma como separador decimal si está presente

            // Si ya es un número flotante válido y contiene un punto decimal, simplemente parsearlo.
            if (!isNaN(parseFloat(s)) && s.includes('.')) {
                return parseFloat(s);
            }

            // Si no tiene punto decimal, asume que es una cadena de dígitos donde el decimal debe ser insertado.
            const isNeg = s.startsWith('-');
            let digitsOnly = isNeg ? s.substring(1) : s;

            if (digitsOnly.length >= 2) {
                // Insertar el punto decimal después del segundo dígito
                let integerPart = digitsOnly.slice(0, 2);
                let decimalPart = digitsOnly.slice(2);
                return parseFloat(integerPart + '.' + decimalPart) * (isNeg ? -1 : 1);
            } else {
                // Si la cadena es más corta de 2 dígitos (ej. "5", "1"), tratar como un flotante simple.
                return parseFloat(s); // Usar la cadena original `s` para preservar el signo negativo.
            }
        }

        /**
         * Carga los datos de la ruta desde Google Sheet y los dibuja en el mapa.
         * @param {string} routeName - El nombre de la ruta a cargar.
         */
        async function loadAndDrawGoogleSheetRoute(routeName) {
            clearMapLayers(); // Clear old route/destination features, but not incidents
            loadIncidents(); // Reload incidents to ensure they are visible on top of new route
            searchInputDisplay.textContent = `Ruta: ${routeName}`;
            routeLoadingIndicator.classList.add('show');
            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?ruta=${encodeURIComponent(routeName)}`);
                if (!response.ok) throw new Error(`Error del servidor: ${response.status}`);
                const data = await response.json();
                if (!Array.isArray(data) || data.length < 2) throw new Error("Datos de ruta inválidos.");
                
                // Convierte todas las coordenadas a Web Mercator ([longitud, latitud])
                const olLatLngs = data.map(c => fromLonLat([parseCoordinate(c.lng), parseCoordinate(c.lat)]));
                
                // Crea la característica de la polilínea
                const routeFeature = new ol.Feature({
                    geometry: new LineString(olLatLngs),
                    type: 'route' // Add type to identify feature
                });
                routeFeature.setStyle(new Style({
                    stroke: new Stroke({
                        color: '#007AFF', // Azul de Apple
                        width: 6,
                        opacity: 0.8
                    })
                }));
                routeVectorSource.addFeature(routeFeature); // Añade a la fuente de vectores común

                // Ajusta el mapa a la extensión de la ruta
                map.getView().fit(routeFeature.getGeometry().getExtent(), {
                    padding: [50, 50, 50, 50], // Añade relleno alrededor de la ruta
                    duration: 1000
                });
                
                // Crea los marcadores de inicio y fin como Overlays para HTML personalizado
                const startMarkerEl = document.createElement('div');
                startMarkerEl.className = 'route-marker-div';
                startMarkerEl.textContent = 'A';
                routeStartOverlay = new Overlay({
                    element: startMarkerEl,
                    position: olLatLngs[0],
                    positioning: 'center-center'
                });
                map.addOverlay(routeStartOverlay);

                const endMarkerEl = document.createElement('div');
                endMarkerEl.className = 'route-marker-div';
                endMarkerEl.textContent = 'B';
                routeEndOverlay = new Overlay({
                    element: endMarkerEl,
                    position: olLatLngs[olLatLngs.length - 1],
                    positioning: 'center-center'
                });
                map.addOverlay(routeEndOverlay);

                showNotification(`Ruta '${routeName}' cargada.`, 3000);

            } catch (error) {
                showNotification(`Error al cargar ruta: ${error.message}`, 5000);
                console.error("Error loading route:", error);
            } finally {
                routeLoadingIndicator.classList.remove('show');
            }
        }

        /**
         * Procesa un destino puntual y lo marca en el mapa.
         * @param {object} destination - Objeto que contiene nombre, lat y lng.
         */
        function processPointDestination(destination) {
            clearMapLayers(); // Clear old route/destination features, but not incidents
            loadIncidents(); // Reload incidents
            searchInputDisplay.textContent = destination.name;
            const latLng = [parseCoordinate(destination.lng), parseCoordinate(destination.lat)]; // OpenLayers: [lng, lat]
            const olCoords = fromLonLat(latLng);

            if (isNaN(olCoords[0]) || isNaN(olCoords[1])) {
                console.error("Invalid coordinates for destination:", destination);
                return;
            }
            
            // Crea un elemento HTML personalizado para el marcador de destino
            const destIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`;
            const destinationMarkerEl = document.createElement('div');
            destinationMarkerEl.className = 'destination-icon-div';
            destinationMarkerEl.innerHTML = destIconSvg;

            destinationOverlay = new Overlay({
                element: destinationMarkerEl,
                position: olCoords,
                positioning: 'bottom-center' // Posiciona la punta del marcador en las coordenadas
            });
            map.addOverlay(destinationOverlay);

            // Añade un popup al hacer clic en el marcador
            destinationMarkerEl.addEventListener('click', () => {
                const popupContent = `<b>Destino:</b><br>${destination.name}`;
                showNotification(popupContent, 5000); // Usando la notificación existente para simplificar
            });

            if (userLocationOverlay && userLocationOverlay.getPosition()) {
                // Ajusta los límites para incluir tanto al usuario como al destino
                const userCoords = userLocationOverlay.getPosition();
                const extent = ol.extent.createEmpty();
                ol.extent.extend(extent, userCoords);
                ol.extent.extend(extent, olCoords);
                map.getView().fit(extent, {
                    padding: [100, 100, 100, 100],
                    duration: 1000
                });
            } else {
                map.getView().setCenter(olCoords);
                map.getView().setZoom(15);
            }
        }
        
        /**
         * Procesa los parámetros de la URL para cargar una ruta o un destino al cargar el mapa.
         */
        function processUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const routeName = params.get('routeName');
            const destination = params.get('destination');

            if (routeName) {
                loadAndDrawGoogleSheetRoute(routeName);
            } else if (destination) {
                try {
                    processPointDestination(JSON.parse(destination));
                } catch (e) { console.error("Error al procesar el destino:", e); }
            }
            
            // Limpia la URL después de procesar
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }

        /**
         * Redirige a la pantalla de búsqueda, conservando la vista actual del mapa.
         */
        function redirectToSearchScreen() {
            if (!map) return;
            const view = map.getView();
            const center = toLonLat(view.getCenter()); // Convierte de nuevo a [lon, lat]
            localStorage.setItem('mapLastView', JSON.stringify({ lat: center[1], lng: center[0], zoom: view.getZoom() }));
            window.location.href = SEARCH_PAGE_URL;
        }

        /**
         * Envía datos de incidentes a Google Apps Script.
         * @param {string} incidentType - Tipo de incidente (ej., "Tráfico Lento").
         * @param {string} description - Descripción del incidente.
         */
        async function sendIncidentData(incidentType, description) {
            if (!userCurrentLatitude || !userCurrentLongitude) {
                showNotification('No se pudo obtener la ubicación para reportar el incidente.', 4000);
                return;
            }

            const submitButton = document.getElementById('submit-incident-button');
            submitButton.disabled = true;
            submitButton.textContent = 'Enviando...';

            try {
                const dataToSend = {
                    evento: incidentType,
                    lat: userCurrentLatitude,
                    lng: userCurrentLongitude,
                    description: description // Include description if your Apps Script can handle it
                };

                const response = await fetch(INCIDENT_APP_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for simple POST requests to Apps Script from client-side
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dataToSend),
                });

                // Since we are using 'no-cors' mode, we cannot directly read the response body.
                // Assume success if no network error.
                showNotification('¡Incidente reportado, gracias!', 4000);
                toggleModal(incidentFormOverlay, false);
                incidentForm.reset();
                loadIncidents(); // Reload incidents to show the newly added one
            } catch (error) {
                console.error("Error al enviar incidente:", error);
                showNotification('Error al reportar incidente. Inténtalo de nuevo.', 4000);
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Reportar Incidente';
            }
        }

        /**
         * Carga los incidentes existentes desde Google Apps Script y los muestra en el mapa.
         */
        async function loadIncidents() {
            // Remove existing incident markers before loading new ones
            const existingIncidentOverlays = map.getOverlays().getArray().filter(overlay => 
                overlay.getElement() && overlay.getElement().classList.contains('incident-icon-div')
            );
            existingIncidentOverlays.forEach(overlay => map.removeOverlay(overlay));

            // Also clear incident features from the vector source if they were added as features
            const incidentFeaturesToRemove = routeVectorSource.getFeatures().filter(feature => 
                feature.get('type') === 'incident'
            );
            incidentFeaturesToRemove.forEach(feature => routeVectorSource.removeFeature(feature));


            try {
                const response = await fetch(INCIDENT_APP_SCRIPT_URL, { method: 'GET' });
                if (!response.ok) throw new Error(`Error al cargar incidentes: ${response.statusText}`);
                const incidents = await response.json();

                incidents.forEach(incident => {
                    addIncidentMarker(incident);
                });
                console.log(`Cargados ${incidents.length} incidentes.`);
            } catch (error) {
                console.error("Error al cargar incidentes:", error);
                showNotification('No se pudieron cargar los incidentes.', 3000);
            }
        }

        /**
         * Agrega un marcador de incidente al mapa.
         * @param {object} incident - Objeto de incidente con lat, lng y evento.
         */
        function addIncidentMarker(incident) {
            const incidentCoords = fromLonLat([parseCoordinate(incident.lng), parseCoordinate(incident.lat)]);
            
            const incidentIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-triangle"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>`;
            const incidentMarkerEl = document.createElement('div');
            incidentMarkerEl.className = 'incident-icon-div';
            incidentMarkerEl.innerHTML = incidentIconSvg;
            
            const incidentOverlay = new Overlay({
                element: incidentMarkerEl,
                position: incidentCoords,
                positioning: 'center-center' // Centra el ícono en las coordenadas
            });
            map.addOverlay(incidentOverlay);

            incidentMarkerEl.addEventListener('click', () => {
                const descriptionText = incident.description ? `<br>Descripción: ${incident.description}` : '';
                showNotification(`Incidente: ${incident.evento}${descriptionText}<br>Reportado: ${new Date(incident.timestamp).toLocaleString()}`, 5000);
            });

            // Optional: You could also add incidents as Features to routeVectorSource
            // const incidentFeature = new ol.Feature({
            //     geometry: new Point(incidentCoords),
            //     type: 'incident', // Custom property to identify it later
            //     details: incident // Store full incident details
            // });
            // incidentFeature.setStyle(new Style({
            //     image: new Circle({
            //         radius: 10,
            //         fill: new Fill({ color: 'rgba(255, 59, 48, 0.7)' }), // Red color for incidents
            //         stroke: new Stroke({ color: 'white', width: 2 })
            //     })
            // }));
            // routeVectorSource.addFeature(incidentFeature);
        }


        // --- Configuración de Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            initMap();

            document.getElementById('allow-location').addEventListener('click', () => {
                toggleModal(locationPermissionOverlay, false);
                requestUserLocation();
            });
            document.getElementById('deny-location').addEventListener('click', () => {
                localStorage.setItem(LOCATION_PERMISSION_KEY, 'denied');
                toggleModal(locationPermissionOverlay, false);
                toggleModal(locationErrorOverlay, true);
            });
            document.getElementById('retry-location').addEventListener('click', () => {
                toggleModal(locationErrorOverlay, false);
                requestUserLocation();
            });
            document.getElementById('use-default-location').addEventListener('click', () => {
                toggleModal(locationErrorOverlay, false);
                setDefaultUserLocation();
            });

            document.getElementById('close-form-button').addEventListener('click', () => toggleModal(formModalOverlay, false));

            dataForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const submitButton = document.getElementById('submit-form-button');
                submitButton.disabled = true;
                submitButton.textContent = 'Enviando...';
                
                try {
                    const response = await fetch(`${FORM_SUBMIT_URL}?${new URLSearchParams(new FormData(dataForm)).toString()}`);
                    const resultText = await response.text();
                    if (resultText.includes("Datos recibidos")) {
                        showNotification('¡Gracias! Tus datos han sido enviados.', 4000);
                        toggleModal(formModalOverlay, false);
                        dataForm.reset();
                    } else { throw new Error('Respuesta inesperada del servidor.'); }
                } catch (error) {
                    showNotification('Error al enviar. Inténtalo de nuevo.', 4000);
                } finally {
                     submitButton.disabled = false;
                     submitButton.textContent = 'Enviar Datos';
                }
            });
            
            // Muestra el formulario después de 3 minutos
            setTimeout(() => {
                toggleModal(formModalOverlay, true);
            }, 180000);

            document.getElementById('go-button').addEventListener('click', redirectToSearchScreen);
            document.getElementById('search-container').addEventListener('click', redirectToSearchScreen);
            document.getElementById('center-location-button').addEventListener('click', () => {
                if (userLocationOverlay && userLocationOverlay.getPosition()) {
                    map.getView().setCenter(userLocationOverlay.getPosition());
                    map.getView().setZoom(16);
                    showNotification('Ubicación centrada', 1500);
                } else {
                    toggleModal(locationPermissionOverlay, true);
                }
            });

            // --- Incident Reporting Event Listeners ---
            document.getElementById('report-incident-button').addEventListener('click', () => {
                if (userCurrentLatitude && userCurrentLongitude) {
                    toggleModal(reportIncidentOverlay, true);
                } else {
                    showNotification('Necesitamos tu ubicación para reportar un incidente.', 4000);
                    // Optionally, prompt for location permission again
                    toggleModal(locationPermissionOverlay, true);
                }
            });

            document.getElementById('confirm-report-incident-button').addEventListener('click', () => {
                toggleModal(reportIncidentOverlay, false);
                toggleModal(incidentFormOverlay, true);
            });

            document.getElementById('cancel-report-incident-button').addEventListener('click', () => {
                toggleModal(reportIncidentOverlay, false);
            });

            document.getElementById('close-incident-form-button').addEventListener('click', () => {
                toggleModal(incidentFormOverlay, false);
                incidentForm.reset(); // Reset form when closed
            });

            incidentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const incidentType = document.getElementById('incident-type').value;
                const incidentDescription = document.getElementById('incident-description').value;
                await sendIncidentData(incidentType, incidentDescription);
            });

            // OpenLayers generalmente maneja el redimensionamiento automáticamente con CSS, pero una actualización manual no está de más
            window.addEventListener('resize', () => { if (map) map.updateSize(); });
        });
    </script>
</body>
</html>
