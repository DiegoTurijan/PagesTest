<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-T">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interfaz Waze Minimalista</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" xintegrity="sha512-Fo3rlrZj/k7ujTnHg4CGR2D7kSs0v4LLanw2qksYuRlEzO+tcaEPQogQ0KaoGN26/zrn20ImR1DfuLWnOo7aBA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; overflow: hidden; }
        #map { height: 100%; width: 100%; z-index: 0; }
        .leaflet-control-attribution a { color: #0078A8 !important; }
        .leaflet-popup-content-wrapper, .leaflet-popup-tip { background: white; box-shadow: 0 3px 14px rgba(0,0,0,0.4); border-radius: 8px; }
        #notification, #map-loading-indicator {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 10000;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            pointer-events: none;
        }
        #notification.show, #map-loading-indicator.show { opacity: 1; }
        .destination-icon-div {
            width: 28px; height: 28px; background-color: #EF4444; border-radius: 50% 50% 50% 0;
            transform: rotate(-45deg); display: flex; align-items: center; justify-content: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3); border: 2px solid white;
        }
        .destination-icon-div i { transform: rotate(45deg); color: white; font-size: 14px; }
        .route-marker-icon {
            background-color: #10B981; /* emerald-500 */
            color: white;
            border-radius: 50%;
            text-align: center;
            font-weight: bold;
            line-height: 20px; /* Ajustar según el tamaño */
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="relative h-screen w-screen flex flex-col">
        <div class="absolute top-0 left-0 right-0 z-10 p-4 bg-white/90 backdrop-blur-md shadow-lg rounded-b-xl md:rounded-none">
            <div class="max-w-3xl mx-auto flex items-center space-x-2 sm:space-x-4">
                <input type="text" id="search-input" placeholder="¿A dónde vas o qué ruta cargas?"
                       class="flex-grow p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-shadow cursor-pointer"
                       readonly>
                <button id="go-button"
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">
                    Ir
                </button>
            </div>
        </div>
        <div id="map" class="flex-grow"></div>
        <button id="center-location-button" title="Mi Ubicación" class="absolute bottom-28 right-4 z-10 bg-white p-3 rounded-full shadow-xl hover:bg-gray-100 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-blue-600"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="3"></circle></svg>
        </button>
        <div id="notification"></div>
        <div id="map-loading-indicator">Cargando...</div>
    </div>

    <script>
        const PUEBLA_LAT = 19.0414;
        const PUEBLA_LNG = -98.2063;
        let map;
        let userMarker;
        let destinationMarker; // Para destinos puntuales
        let currentRoutePolyline; // Para rutas de Google Sheets
        let routeStartMarker, routeEndMarker; // Marcadores para inicio/fin de ruta de Sheets

        const SEARCH_PAGE_URL = 'search_screen.html';
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzCjSRkHlyfjWcgnd2JfFbfVtfsnLisVCXZLanIULRk8iWwW7bTBVZx3SIgxewaMupU/exec';
        const mapLoadingIndicator = document.getElementById('map-loading-indicator');

        function showMapLoading(message = "Cargando datos en el mapa...") {
            mapLoadingIndicator.textContent = message;
            mapLoadingIndicator.classList.add('show');
        }
        function hideMapLoading() {
            mapLoadingIndicator.classList.remove('show');
        }

        function showNotification(message, duration = 3000) {
            const notificationElement = document.getElementById('notification');
            notificationElement.textContent = message;
            notificationElement.classList.add('show');
            setTimeout(() => {
                notificationElement.classList.remove('show');
            }, duration);
        }

        function initMap() {
            try {
                map = L.map('map', { zoomControl: false }).setView([PUEBLA_LAT, PUEBLA_LNG], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                    maxZoom: 19,
                }).addTo(map);
                L.control.zoom({ position: 'bottomright' }).addTo(map);
                
                showNotification("Mapa inicializado.", 2000);
                // El procesamiento de destino/ruta se hará después de obtener la ubicación del usuario
                simulateUserLocation();

            } catch (error) {
                console.error("Error al inicializar el mapa:", error);
                showNotification("Error al cargar el mapa.", 5000);
            }
        }

        function simulateUserLocation() {
            // ... (código de simulateUserLocation y setDefaultUserLocation se mantiene igual)
            // PERO, al final de obtener la ubicación (o la de por defecto), llamamos a una función que decida qué procesar:
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    map.setView([userLat, userLng], 15);
                    if (userMarker) userMarker.setLatLng([userLat, userLng]);
                    else {
                         const userIcon = L.divIcon({html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-md"></div>', className: '', iconSize: [16,16], iconAnchor: [8,8]});
                         userMarker = L.marker([userLat, userLng], {icon: userIcon}).addTo(map).bindPopup("<b>¡Estás aquí!</b>").openPopup();
                    }
                    showNotification("Ubicación actual obtenida.", 2000);
                    processUrlParameters(); // Llama a la función que decide qué cargar
                }, () => {
                    setDefaultUserLocation();
                    showNotification("No se pudo obtener la ubicación.", 3000);
                    processUrlParameters();
                });
            } else {
                setDefaultUserLocation();
                showNotification("Geolocalización no soportada.", 3000);
                processUrlParameters();
            }
        }
        
        function setDefaultUserLocation() {
            if (userMarker) userMarker.setLatLng([PUEBLA_LAT, PUEBLA_LNG]);
            else {
                const userIcon = L.divIcon({html: '<div class="w-4 h-4 bg-blue-500 rounded-full border-2 border-white shadow-md"></div>', className: '', iconSize: [16,16], iconAnchor: [8,8]});
                userMarker = L.marker([PUEBLA_LAT, PUEBLA_LNG], {icon: userIcon}).addTo(map).bindPopup("<b>Ubicación por defecto</b>").openPopup();
            }
            if (!map.getBounds().contains(L.latLng(PUEBLA_LAT, PUEBLA_LNG))) {
                 map.setView([PUEBLA_LAT, PUEBLA_LNG], 13);
            }
        }

        function clearMapLayers() { // Función para limpiar capas previas
            if (destinationMarker) map.removeLayer(destinationMarker);
            if (currentRoutePolyline) map.removeLayer(currentRoutePolyline);
            if (routeStartMarker) map.removeLayer(routeStartMarker);
            if (routeEndMarker) map.removeLayer(routeEndMarker);
        }

        async function loadAndDrawGoogleSheetRoute(routeName) {
            clearMapLayers();
            document.getElementById('search-input').value = `Ruta: ${routeName}`;
            showMapLoading(`Cargando ruta '${routeName}' desde Google Sheets...`);

            try {
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?ruta=${encodeURIComponent(routeName)}`);
                if (!response.ok) {
                    const errorText = await response.text();
                    if (errorText.includes("RUTA NO ENCONTRADA")) throw new Error("RUTA NO ENCONTRADA");
                    throw new Error(`Error del servidor: ${response.status}`);
                }
                const coordinatesData = await response.json();

                if (!Array.isArray(coordinatesData) || coordinatesData.length === 0) {
                    throw new Error("No se recibieron coordenadas o el formato es incorrecto.");
                }

                const latLngs = coordinatesData.map(coord => {
                    const lat = parseFloat(coord.lat);
                    const lng = parseFloat(coord.lng);
                    if (isNaN(lat) || isNaN(lng)) {
                        console.warn("Coordenada inválida encontrada y omitida:", coord);
                        return null;
                    }
                    return [lat, lng];
                }).filter(c => c !== null); // Filtrar nulos si alguna coordenada era inválida


                if (latLngs.length < 2) {
                     throw new Error("Se necesitan al menos dos puntos válidos para trazar una ruta.");
                }

                currentRoutePolyline = L.polyline(latLngs, { color: '#D97706', weight: 5, opacity: 0.9 }).addTo(map);
                map.fitBounds(currentRoutePolyline.getBounds().pad(0.1));

                // Marcadores de inicio y fin
                const startIcon = L.divIcon({className: 'route-marker-icon', html: 'A', iconSize: [20, 20]});
                const endIcon = L.divIcon({className: 'route-marker-icon', html: 'B', iconSize: [20, 20]});

                routeStartMarker = L.marker(latLngs[0], {icon: startIcon}).addTo(map).bindPopup(`Inicio: ${routeName}<br><small>${coordinatesData[0].fecha || ''}</small>`);
                routeEndMarker = L.marker(latLngs[latLngs.length - 1], {icon: endIcon}).addTo(map).bindPopup(`Fin: ${routeName}<br><small>${coordinatesData[latLngs.length-1].fecha || ''}</small>`);
                
                showNotification(`Ruta '${routeName}' cargada correctamente.`, 3000);

            } catch (error) {
                console.error(`Error loading Google Sheet route '${routeName}':`, error);
                showNotification(`Error al cargar ruta '${routeName}': ${error.message}`, 5000);
                document.getElementById('search-input').value = `Error cargando: ${routeName}`;
            } finally {
                hideMapLoading();
                // Limpiar parámetro de la URL
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            }
        }

        function processPointDestination(destination) {
            clearMapLayers();
            document.getElementById('search-input').value = destination.name;
            let destLat, destLng;

            if (destination.lat && destination.lng && !isNaN(parseFloat(destination.lat)) && !isNaN(parseFloat(destination.lng))) {
                destLat = parseFloat(destination.lat);
                destLng = parseFloat(destination.lng);
            } else {
                showNotification(`Destino: ${destination.name} (sin coordenadas válidas).`, 3000);
                return;
            }
            
            const destinationLatLng = L.latLng(destLat, destLng);
            const destIcon = L.divIcon({ html: '<div class="destination-icon-div"><i class="fas fa-map-marker-alt"></i></div>', className: '', iconSize: [28, 28], iconAnchor: [14, 28], popupAnchor: [0, -28] });
            destinationMarker = L.marker(destinationLatLng, { icon: destIcon })
                .addTo(map)
                .bindPopup(`<b>Destino:</b><br>${destination.name}${destination.address ? '<br><small>' + destination.address + '</small>' : ''}`)
                .openPopup();

            // Simular ruta al destino puntual si hay ubicación de usuario
            if (userMarker) {
                 const userLatLng = userMarker.getLatLng();
                 currentRoutePolyline = L.polyline([userLatLng, destinationLatLng], { color: '#3B82F6', weight: 6, opacity: 0.8, dashArray: '5, 5' }).addTo(map);
                 map.fitBounds(L.latLngBounds([userLatLng, destinationLatLng]).pad(0.2));
                 showNotification(`Ruta simulada a ${destination.name} trazada.`, 2000);
            } else {
                map.setView(destinationLatLng, 15); // Centrar en el destino si no hay ruta
            }
            // Limpiar parámetro de la URL
            const newUrl = window.location.pathname;
            window.history.replaceState({}, document.title, newUrl);
        }


        function processUrlParameters() {
            const params = new URLSearchParams(window.location.search);
            const routeNameParam = params.get('routeName');
            const destinationParam = params.get('destination');

            if (routeNameParam) {
                loadAndDrawGoogleSheetRoute(routeNameParam);
            } else if (destinationParam) {
                try {
                    const destination = JSON.parse(destinationParam);
                    processPointDestination(destination);
                } catch (e) {
                    console.error("Error al procesar el destino puntual:", e);
                    showNotification("Error al leer datos del destino.", 3000);
                }
            } else {
                // No hay parámetros de ruta o destino, restaurar vista si existe
                const lastView = localStorage.getItem('mapLastView');
                if(lastView){
                    try {
                        const view = JSON.parse(lastView);
                        map.setView([view.lat, view.lng], view.zoom);
                        localStorage.removeItem('mapLastView');
                    } catch (e) { console.error("Error al restaurar vista de mapa:", e); }
                }
            }
        }

        function redirectToSearchScreen() {
            // ... (código de redirectToSearchScreen se mantiene igual)
            const currentCenter = map.getCenter();
            const currentZoom = map.getZoom();
            localStorage.setItem('mapLastView', JSON.stringify({ lat: currentCenter.lat, lng: currentCenter.lng, zoom: currentZoom }));
            window.location.href = SEARCH_PAGE_URL;
        }

        document.addEventListener('DOMContentLoaded', () => {
            initMap(); // initMap ahora llama a simulateUserLocation, que luego llama a processUrlParameters

            const goButton = document.getElementById('go-button');
            const searchInput = document.getElementById('search-input'); // El input en sí
            const centerLocationButton = document.getElementById('center-location-button');

            goButton.addEventListener('click', redirectToSearchScreen);
            searchInput.addEventListener('click', redirectToSearchScreen); // Al hacer clic en el input
            searchInput.addEventListener('keypress', (e) => { e.preventDefault(); }); // Prevenir escritura

            centerLocationButton.addEventListener('click', () => {
                if (userMarker) {
                    map.setView(userMarker.getLatLng(), 15);
                    userMarker.openPopup();
                    showNotification("Mapa centrado en tu ubicación.", 2000);
                } else {
                    simulateUserLocation(); // Intentar obtener ubicación de nuevo
                }
            });

            window.addEventListener('resize', () => {
                if (map) { map.invalidateSize(); }
            });
        });
    </script>
</body>
</html>

